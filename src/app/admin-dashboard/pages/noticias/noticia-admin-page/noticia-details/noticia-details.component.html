<form
  [formGroup]="noticiaForm"
  (ngSubmit)="onSubmit()"
  class="space-y-6"
>
  <!-- 1. Datos Generales -->
  <section>
    <h2 class="text-lg font-bold">Datos Generales</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
      <div>
        <label class="label">
          <span class="label-text font-semibold">Slug *</span>
        </label>
        <input
          type="text"
          formControlName="slug"
          class="input input-bordered w-full"
        />
        <form-error-label [control]="noticiaForm.get('slug')!" />

      </div>
      <div>
        <label class="label">
          <span class="label-text font-semibold">Tags (separados por comas)</span>
        </label>
        <input
          type="text"
          formControlName="tags"
          class="input input-bordered w-full"
        />
      </div>
      <div>
        <label class="label">
          <span class="label-text font-semibold">País</span>
        </label>
        <input
          type="text"
          formControlName="pais"
          class="input input-bordered w-full"
        />
      </div>
      <div>
        <label class="label">
          <span class="label-text font-semibold">Código País</span>
        </label>
        <input
          type="text"
          formControlName="paisCode"
          class="input input-bordered w-full"
        />
      </div>
      <div>
        <label class="label">
          <span class="label-text font-semibold">Ciudad</span>
        </label>
        <input
          type="text"
          formControlName="ciudad"
          class="input input-bordered w-full"
        />
      </div>
      <div>
        <label class="label">
          <div
            class="tooltip tooltip-bottom z-50"
            data-tip="Estado de la noticia: &#10;Publicado (Muestra en Web),&#10;Editando (En espera a ser publicado)&#10;o Borrador (No se muestra en Web)"
          >
            <span class="label-text font-semibold cursor-help">Estado *</span>
          </div>
        </label>
        <select
          formControlName="state"
          class="select select-bordered w-full"
        >
          <option value="active">Publicado</option>
          <option value="editing">Editando</option>
          <option value="deleted">Borrado</option>
        </select>
        <form-error-label [control]="noticiaForm.get('state')!" />
      </div>
      <div>
        <label class="label">
          <span class="label-text font-semibold">Fecha de la noticia *</span>
        </label>
        <input
          type="date"
          formControlName="displayDate"
          class="input input-bordered w-full"
        />
        <form-error-label [control]="noticiaForm.get('slug')!" />

      </div>

      <div>
        <label class="label">
          <span class="label-text font-semibold">Latitud</span>
        </label>
        <input
          type="text"
          formControlName="latitud"
          class="input input-bordered w-full"
        />
      </div>
      <div>
        <label class="label">
          <span class="label-text font-semibold">Longitud</span>
        </label>
        <input
          type="text"
          formControlName="longitud"
          class="input input-bordered w-full"
        />
      </div>
    </div>
  </section>

  <!-- 2. Imágenes -->
  <section formArrayName="images">
    <h2 class="text-lg font-bold">Imágenes</h2>

    @for(image of imagesFormArray.controls; track image; let i = $index) {
    <div
      class="border p-3 mt-2 rounded-md space-y-2"
      [formGroupName]="i"
    >
      <!-- Input de archivo -->
      <div>
        <label class="label">
          <span class="label-text font-semibold">Seleccionar Imagen</span>
        </label>
        <input
          type="file"
          accept="image/*"
          class="file-input file-input-bordered w-full"
          (change)="onSingleImageSelected($event, i)"
        />
      </div>

      <!-- Vista previa -->
      @if (previewImageUrls()[i] || imagesFormArray.at(i).get('url')?.value) {
      <div class="mt-2">
        <img
          [src]="previewImageUrls()[i] || getImageUrl(imagesFormArray.at(i).get('url')?.value)"
          alt="Vista previa"
          class="w-full max-w-xs rounded shadow-md"
        />
      </div>
      }

      <!-- URL de la imagen -->
      <div>
        <label class="label">
          <span class="label-text font-semibold">URL de la Imagen</span>
        </label>
        <input
          type="text"
          formControlName="url"
          placeholder="URL de la imagen"
          class="input input-bordered w-full"
          readonly
          tabindex="-1"
        />
      </div>

      <!-- Alt Text -->
      <div>
        <label class="label">
          <span class="label-text font-semibold">Texto Alternativo</span>
        </label>
        <input
          type="text"
          formControlName="altText"
          placeholder="Texto alternativo"
          class="input input-bordered w-full"
        />
        <form-error-label [control]="imagesFormArray.at(i).get('altText')!" />
      </div>

      <!-- Botón eliminar -->
      <button
        class="btn btn-outline btn-error"
        type="button"
        (click)="removeImage(i)"
      >
        Eliminar
      </button>
    </div>
    }

    <div class="flex flex-col gap-2 mt-2">
      <form-error-label [control]="noticiaForm.get('images')!" />
      <button
        class="btn btn-primary self-start"
        type="button"
        (click)="addImage()"
      >
        + Agregar Imagen
      </button>
    </div>
  </section>

  <!-- 3. Enlaces -->
  <section formArrayName="enlaces">
    <h2 class="text-lg font-bold">Enlaces</h2>
    @for(enlace of enlacesFormArray.controls; track enlace; let i = $index) {
    <div
      class="border p-3 mt-2 rounded-md space-y-2"
      [formGroupName]="i"
    >
      <div>
        <label class="label">
          <span class="label-text font-semibold">Texto Visible del Enlace</span>
        </label>
        <input
          type="text"
          formControlName="label"
          placeholder="Texto visible"
          class="input input-bordered w-full"
        />
      </div>
      <div>
        <label class="label">
          <span class="label-text font-semibold">URL del Enlace</span>
        </label>
        <input
          type="text"
          formControlName="url"
          placeholder="URL del sitio"
          class="input input-bordered w-full"
        />
      </div>
      <button
        class="btn btn-outline btn-error"
        type="button"
        (click)="removeEnlace(i)"
      >Eliminar</button>
    </div>
    }
    <button
      class="btn btn-primary mt-2"
      type="button"
      (click)="addEnlace()"
    >+ Agregar Enlace</button>
  </section>

  <!-- 4. Traducciones -->
  <section formArrayName="traducciones">
    <h2 class="text-lg font-bold">Traducciones</h2>
    @for(t of traduccionesFormArray.controls; track t; let i = $index) {
    <div
      class="border p-3 mt-2 rounded-md space-y-2"
      [formGroupName]="i"
    >
      <div>
        <label class="label">
          <span class="label-text font-semibold">Idioma</span>
        </label>
        <select
          formControlName="idioma"
          class="select select-bordered w-full"
        >
          <option value="">Seleccione un idioma</option>
          <option value="es">Español</option>
          <option value="en">Inglés</option>
        </select>
        <form-error-label [control]="traduccionesFormArray.at(i).get('idioma')!" />

      </div>
      <div>
        <label class="label">
          <span class="label-text font-semibold">Título</span>
        </label>
        <input
          type="text"
          formControlName="title"
          placeholder="Título"
          class="input input-bordered w-full"
        />
        <form-error-label [control]="traduccionesFormArray.at(i).get('title')!" />
      </div>
      <div>
        <label class="label">
          <span class="label-text font-semibold">Descripción Corta</span>
        </label>
        <input
          type="text"
          formControlName="contentDescription"
          placeholder="Descripción corta"
          class="input input-bordered w-full"
        />
        <form-error-label [control]="traduccionesFormArray.at(i).get('contentDescription')!" />
      </div>
      <div>
        <label class="label">
          <span class="label-text font-semibold">Contenido</span>
        </label>
        <textarea
          formControlName="content"
          rows="5"
          placeholder="Contenido HTML"
          class="textarea textarea-bordered w-full"
        ></textarea>
        <form-error-label [control]="traduccionesFormArray.at(i).get('content')!" />
      </div>
      <button
        class="btn btn-outline btn-error"
        type="button"
        (click)="removeTraduccion(i)"
      >Eliminar</button>
    </div>
    }
    <button
      class="btn btn-primary mt-2"
      type="button"
      (click)="addTraduccion()"
    >+ Agregar Traducción</button>
  </section>

  <!-- 5. Instituciones -->
  <section>
    <h2 class="text-lg font-bold">Instituciones Relacionadas</h2>
    <div class="space-y-2 mt-2">
      @for (institucion of instituciones(); track institucion.id) {
      <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-base-50">
        <input
          type="checkbox"
          class="checkbox"
          [value]="institucion.id"
          [checked]="isInstitucionSelected(institucion.id)"
          (change)="onInstitucionChange($event, institucion.id)"
        />
        <div class="flex-1">
          <span class="font-medium">{{ getInstitucionName(institucion) }}</span>
          <span class="text-sm text-gray-500 ml-2">({{ institucion.pais }})</span>
        </div>
      </label>
      }
    </div>
  </section>

  <div class="flex justify-end mt-10">
    <button
      class="btn"
      [class.btn-success]="!isSaving()"
      [class.btn-outline]="isSaving()"
      [disabled]="isSaving()"
      type="submit"
    >
      @if (isSaving()) {
      <span class="loading loading-spinner loading-sm"></span>
      Guardando...
      } @else {
      Guardar
      }
    </button>
  </div>

</form>

<!-- Sistema de alertas personalizado - FUERA DEL FORMULARIO -->
<div class="mb-20">

  <alert-message
    [message]="alertMessage()"
    [type]="alertType()"
    [show]="showAlert()"
    (onClose)="onAlertClose()"
  ></alert-message>
</div>